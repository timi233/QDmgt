FROM python:3.11-slim

LABEL maintainer="QDmgt Team"
LABEL description="Channel Management System - Backend API"

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# å®‰è£…ç³»ç»Ÿä¾èµ–\n# - build-essential: ç¼–è¯‘å·¥å…·é“¾ï¼ˆgcc, g++, makeç­‰ï¼‰\n# - libpq-dev: PostgreSQLå®¢æˆ·ç«¯å¼€å‘åº“\n# - python3-dev: Pythonå¼€å‘å¤´æ–‡ä»¶\n# - curl: å¥åº·æ£€æŸ¥å·¥å…·\n# - rustc cargo: Rustç¼–è¯‘å™¨ï¼ˆpydantic-coreéœ€è¦ï¼‰\nENV http_proxy=http://192.168.101.20:7890\nENV https_proxy=http://192.168.101.20:7890\nENV no_proxy=localhost,127.0.0.1\n\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends \\\n        build-essential \\\n        libpq-dev \\\n        python3-dev \\\n        curl \\\n        rustc \\\n        cargo \\\n    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶requirements.txtå¹¶å®‰è£…Pythonä¾èµ–
# æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨COPYä»¥åˆ©ç”¨Dockerç¼“å­˜å±‚ï¼Œä»£ç é€šè¿‡bind mountæŒ‚è½½
COPY backend/requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt && \
    rm /tmp/requirements.txt

# åˆ›å»ºérootç”¨æˆ·è¿è¡Œåº”ç”¨ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN useradd -m -u 1000 -s /bin/bash appuser && \
    chown -R appuser:appuser /app

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8001/health || exit 1

# å¯åŠ¨å‘½ä»¤
# 1. ç­‰å¾…PostgreSQLå°±ç»ªï¼ˆé€šè¿‡docker-composeçš„depends_onå’Œhealthcheckå¤„ç†ï¼‰
# 2. è¿è¡ŒAlembicæ•°æ®åº“è¿ç§»
# 3. å¯åŠ¨UvicornæœåŠ¡å™¨
CMD ["sh", "-c", "\
    cd /app/backend && \
    echo 'ğŸ”„ Running database migrations...' && \
    alembic upgrade head && \
    echo 'âœ… Migrations completed' && \
    echo 'ğŸš€ Starting backend server...' && \
    cd /app && \
    uvicorn backend.src.main:app --host 0.0.0.0 --port 8001 \
"]
