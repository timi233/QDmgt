{
  "id": "IMPL-013",
  "title": "权限管理优化（RBAC细粒度）",
  "status": "pending",
  "meta": {
    "type": "refactor",
    "agent": "@code-developer",
    "sprint": 3,
    "priority": "medium",
    "estimated_hours": 12
  },
  "context": {
    "requirements": [
      "实现 1 个权限模型: 定义 Permission 和 Role 表 (多对多关系)",
      "创建 5 个预定义角色: [SUPER_ADMIN, CHANNEL_ADMIN, SALES_MANAGER, DISTRIBUTOR, VIEWER]",
      "实现 1 个权限检查中间件: checkPermission(permission) 装饰器",
      "前端实现 1 个权限管理页面: 角色权限配置",
      "定义 20 个权限点: [用户管理, 渠道管理, 产品管理, 订单管理, 库存管理, 数据分析等细分权限]"
    ],
    "focus_paths": [
      "backend/prisma/schema.prisma",
      "backend/src/middlewares/permissionMiddleware.ts",
      "frontend/src/pages/RolesPage.tsx"
    ],
    "acceptance": [
      "权限模型创建: 验证 Permission 和 Role 表存在",
      "权限检查生效: 验证无权限访问返回 403",
      "前端按钮隐藏: 验证无权限的按钮不显示",
      "角色配置页面: 验证可以修改角色权限",
      "5 个角色初始化: 验证种子数据包含预定义角色"
    ],
    "depends_on": ["IMPL-006"],
    "artifacts": []
  },
  "flow_control": {
    "pre_analysis": [],
    "implementation_approach": [
      {
        "step": 1,
        "title": "扩展数据模型",
        "description": "添加 Permission 和 Role 表",
        "modification_points": [
          "修改 1 个文件: backend/prisma/schema.prisma (添加 2 个 model, +60 行)",
          "定义 Permission: {id, name, code, description, module}",
          "定义 Role: {id, name, code, description}",
          "定义中间表: RolePermission (多对多)",
          "修改 User model: 添加 roleId 字段"
        ],
        "logic_flow": [
          "Permission model: code 字段唯一 (如: 'user:create', 'channel:update')",
          "module 字段: 权限模块分类 (USER, CHANNEL, PRODUCT, ORDER, INVENTORY, ANALYTICS)",
          "Role model: code 字段唯一 (如: 'super_admin', 'channel_admin')",
          "RolePermission: {roleId, permissionId}",
          "User model: 移除 role 枚举, 添加 roleId 外键",
          "执行迁移: npx prisma migrate dev --name add_rbac"
        ],
        "depends_on": [],
        "output": "rbac_schema"
      },
      {
        "step": 2,
        "title": "创建权限种子数据",
        "description": "初始化 20 个权限和 5 个角色",
        "modification_points": [
          "修改 1 个文件: backend/prisma/seed.ts (添加 RBAC 种子数据, +150 行)"
        ],
        "logic_flow": [
          "创建 20 个 Permission:",
          "USER 模块: user:create, user:read, user:update, user:delete",
          "CHANNEL 模块: channel:create, channel:read, channel:update, channel:delete",
          "PRODUCT 模块: product:create, product:read, product:update, product:delete",
          "ORDER 模块: order:create, order:read, order:update, order:delete",
          "INVENTORY 模块: inventory:read, inventory:adjust",
          "ANALYTICS 模块: analytics:read",
          "COMMISSION 模块: commission:read, commission:settle",
          "创建 5 个 Role:",
          "SUPER_ADMIN: 所有权限",
          "CHANNEL_ADMIN: channel:*, product:read, order:*, inventory:read, analytics:read, commission:read",
          "SALES_MANAGER: order:*, product:read, inventory:read, analytics:read",
          "DISTRIBUTOR: order:create, order:read, product:read, inventory:read",
          "VIEWER: *:read 权限",
          "创建 RolePermission 关联"
        ],
        "depends_on": [1],
        "output": "rbac_seed"
      },
      {
        "step": 3,
        "title": "创建权限检查服务",
        "description": "实现权限验证逻辑",
        "modification_points": [
          "创建 1 个文件: backend/src/services/permission.service.ts (100 行)",
          "实现 2 个方法: [checkPermission(userId, permissionCode), getUserPermissions(userId)]"
        ],
        "logic_flow": [
          "getUserPermissions(userId):",
          "1. 查询 User (包含 role 和 role.permissions 关系)",
          "2. 返回 permission.code 数组",
          "checkPermission(userId, permissionCode):",
          "1. 调用 getUserPermissions",
          "2. 检查 permissionCode 是否在数组中",
          "3. 返回 boolean",
          "4. 支持通配符 (如: 'user:*' 匹配 'user:create', 'user:read')"
        ],
        "depends_on": [2],
        "output": "permission_service"
      },
      {
        "step": 4,
        "title": "创建权限检查中间件",
        "description": "实现 requirePermission 中间件",
        "modification_points": [
          "创建 1 个文件: backend/src/middlewares/permissionMiddleware.ts (80 行)",
          "实现工厂函数: requirePermission(permissionCode)"
        ],
        "logic_flow": [
          "requirePermission(permissionCode): 返回 Express middleware",
          "中间件逻辑:",
          "1. 获取 req.user (由 authMiddleware 注入)",
          "2. 调用 PermissionService.checkPermission(req.user.id, permissionCode)",
          "3. 如果无权限: 抛出 AuthorizationError (403)",
          "4. 如果有权限: 调用 next()",
          "使用示例: router.post('/channels', authMiddleware, requirePermission('channel:create'), controller.create)"
        ],
        "depends_on": [3],
        "output": "permission_middleware"
      },
      {
        "step": 5,
        "title": "应用权限中间件到所有路由",
        "description": "在现有路由添加权限检查",
        "modification_points": [
          "修改 7 个文件: [auth.route.ts, channel.route.ts, product.route.ts, order.route.ts, inventory.route.ts, commission.route.ts, analytics.route.ts]",
          "为每个端点添加 requirePermission 中间件"
        ],
        "logic_flow": [
          "channel.route.ts:",
          "GET /channels: requirePermission('channel:read')",
          "POST /channels: requirePermission('channel:create')",
          "PUT /channels/:id: requirePermission('channel:update')",
          "DELETE /channels/:id: requirePermission('channel:delete')",
          "类似应用到其他路由文件",
          "公开端点 (如 /auth/login) 不需要权限检查"
        ],
        "depends_on": [4],
        "output": "route_protection"
      },
      {
        "step": 6,
        "title": "实现前端权限 Hook",
        "description": "创建 usePermission 和 useHasPermission hooks",
        "modification_points": [
          "修改 1 个文件: frontend/src/hooks/usePermission.ts (扩展, +60 行)",
          "实现 2 个 hooks: [usePermissions (获取用户所有权限), useHasPermission(permission) (检查单个权限)]"
        ],
        "logic_flow": [
          "usePermissions:",
          "1. useQuery 调用 authService.getPermissions (新增 API: GET /auth/permissions)",
          "2. 返回 {permissions: string[], isLoading}",
          "useHasPermission(permission):",
          "1. 调用 usePermissions",
          "2. 检查 permission 是否在 permissions 数组中",
          "3. 支持通配符匹配",
          "4. 返回 boolean"
        ],
        "depends_on": [],
        "output": "permission_hooks"
      },
      {
        "step": 7,
        "title": "更新前端 PermissionGuard 组件",
        "description": "基于新权限系统重构",
        "modification_points": [
          "修改 1 个文件: frontend/src/components/common/PermissionGuard.tsx (重写, 60 行)"
        ],
        "logic_flow": [
          "Props: {permission: string, fallback?: ReactNode, children}",
          "使用 useHasPermission(permission)",
          "如果有权限: 渲染 children",
          "如果无权限: 渲染 fallback (或 null)",
          "使用示例: <PermissionGuard permission='channel:create'><Button>创建渠道</Button></PermissionGuard>"
        ],
        "depends_on": [6],
        "output": "permission_guard"
      },
      {
        "step": 8,
        "title": "实现角色权限管理页面",
        "description": "SUPER_ADMIN 配置角色权限",
        "modification_points": [
          "创建 1 个文件: frontend/src/pages/RolesPage.tsx (300 行)",
          "实现角色列表 + 权限配置 Modal"
        ],
        "logic_flow": [
          "RoleTable: columns [角色名称, 角色代码, 权限数量, 操作]",
          "useQuery 获取角色列表 (roleService.getRoles)",
          "操作列: '配置权限' 按钮",
          "PermissionConfigModal:",
          "1. 显示所有权限 (按 module 分组)",
          "2. CheckboxGroup 选择权限",
          "3. 默认选中角色已有权限",
          "4. 提交: useMutation 调用 roleService.updatePermissions({roleId, permissionIds})",
          "仅 SUPER_ADMIN 可访问此页面"
        ],
        "depends_on": [7],
        "output": "roles_page"
      },
      {
        "step": 9,
        "title": "应用权限控制到所有页面",
        "description": "更新现有页面使用 PermissionGuard",
        "modification_points": [
          "修改 5 个文件: [ChannelsPage.tsx, ProductsPage.tsx, OrdersPage.tsx, InventoryPage.tsx, CommissionsPage.tsx]",
          "为所有操作按钮添加权限保护"
        ],
        "logic_flow": [
          "ChannelsPage.tsx:",
          "<PermissionGuard permission='channel:create'><Button>创建渠道</Button></PermissionGuard>",
          "<PermissionGuard permission='channel:update'><Button>编辑</Button></PermissionGuard>",
          "<PermissionGuard permission='channel:delete'><Button>删除</Button></PermissionGuard>",
          "类似应用到其他页面"
        ],
        "depends_on": [7],
        "output": "page_protection"
      },
      {
        "step": 10,
        "title": "测试",
        "description": "测试 RBAC 完整流程",
        "modification_points": [
          "执行 8 个测试: [权限种子数据, 权限检查 API, 中间件拦截, 前端权限隐藏, 角色配置, 通配符匹配, 多角色, 权限更新]"
        ],
        "logic_flow": [
          "后端测试: 运行种子脚本, 验证 5 个角色和 20 个权限创建",
          "权限检查测试: 创建 DISTRIBUTOR 用户, 尝试访问 POST /channels, 验证返回 403",
          "通配符测试: SUPER_ADMIN 拥有 '*:*' 权限, 验证可访问所有端点",
          "前端测试: 以 DISTRIBUTOR 登录",
          "验证 '创建渠道' 按钮不可见",
          "验证可以查看订单列表",
          "角色配置测试: 以 SUPER_ADMIN 登录, 修改 DISTRIBUTOR 角色权限",
          "添加 'channel:create' 权限",
          "重新以 DISTRIBUTOR 登录, 验证 '创建渠道' 按钮可见",
          "API 测试: 验证可以创建渠道"
        ],
        "depends_on": [5, 8, 9],
        "output": "test_results"
      }
    ],
    "target_files": [
      "backend/prisma/schema.prisma",
      "backend/prisma/seed.ts",
      "backend/src/services/permission.service.ts",
      "backend/src/middlewares/permissionMiddleware.ts",
      "backend/src/routes/auth.route.ts",
      "backend/src/routes/channel.route.ts",
      "backend/src/routes/product.route.ts",
      "backend/src/routes/order.route.ts",
      "backend/src/routes/inventory.route.ts",
      "backend/src/routes/commission.route.ts",
      "backend/src/routes/analytics.route.ts",
      "backend/src/controllers/role.controller.ts",
      "backend/src/routes/role.route.ts",
      "frontend/src/hooks/usePermission.ts",
      "frontend/src/components/common/PermissionGuard.tsx",
      "frontend/src/services/roleService.ts",
      "frontend/src/pages/RolesPage.tsx",
      "frontend/src/pages/ChannelsPage.tsx",
      "frontend/src/pages/ProductsPage.tsx",
      "frontend/src/pages/OrdersPage.tsx",
      "frontend/src/pages/InventoryPage.tsx",
      "frontend/src/pages/CommissionsPage.tsx"
    ]
  }
}
