{
  "id": "IMPL-006",
  "title": "渠道管理模块（CRUD + 层级关系）",
  "status": "pending",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "sprint": 1,
    "priority": "high",
    "estimated_hours": 16
  },
  "context": {
    "requirements": [
      "实现 7 个后端 API 端点: [GET /channels (树形/列表), GET /channels/:id, POST /channels, PUT /channels/:id, DELETE /channels/:id, GET /channels/:id/children, PUT /channels/:id/move]",
      "创建 1 个 ChannelService: 7 个方法 (CRUD + 层级查询 + 移动节点)",
      "前端实现 5 个功能: [树形渠道列表, 创建渠道 Modal, 编辑渠道 Modal, 删除确认, 层级拖拽 (可选)]",
      "实现 2 个权限控制: [只有 ADMIN 可创建/删除渠道, AGENT 只能查看自己的渠道]",
      "构建 1 个树形数据结构: 支持无限层级递归查询"
    ],
    "focus_paths": [
      "backend/src/services/channel.service.ts",
      "backend/src/controllers/channel.controller.ts",
      "backend/src/routes/channel.route.ts",
      "frontend/src/pages/ChannelsPage.tsx",
      "frontend/src/services/channelService.ts"
    ],
    "acceptance": [
      "7 个 API 端点正常工作: 验证 Postman 测试所有端点",
      "树形结构正确: 验证 GET /channels 返回嵌套 children 数组",
      "前端树组件渲染: 验证 Ant Design Tree 显示 4 层级渠道",
      "创建渠道成功: 验证可选择父渠道并创建子渠道",
      "权限控制生效: 验证 AGENT 角色无法访问其他渠道"
    ],
    "depends_on": ["IMPL-005"],
    "artifacts": [
      {
        "type": "analysis",
        "path": ".workflow/.brainstorming/product-manager/analysis.md",
        "priority": "high"
      }
    ]
  },
  "flow_control": {
    "pre_analysis": [],
    "implementation_approach": [
      {
        "step": 1,
        "title": "创建 ChannelService",
        "description": "实现渠道业务逻辑层",
        "modification_points": [
          "创建 1 个文件: backend/src/services/channel.service.ts (250 行)",
          "实现 7 个方法: [getAll(分页+过滤+树形), getById, create(校验层级), update, delete(软删除), getChildren(递归), moveNode(更新 parentId)]"
        ],
        "logic_flow": [
          "getAll: Prisma 查询所有渠道, 支持 tree=true 参数返回树形结构",
          "buildTree 辅助函数: 递归构建树形数据 (parentId === null 为根节点)",
          "getById: Prisma findUnique, 包含 parent 和 children 关系",
          "create: 校验 parentId 存在性, 计算 level (parent.level + 1), Prisma create",
          "update: 校验 level 不可修改 (防止破坏层级), Prisma update",
          "delete: 软删除 (status = INACTIVE), 级联软删除所有子渠道",
          "moveNode: 更新 parentId, 重新计算 level, 防止循环引用"
        ],
        "depends_on": [],
        "output": "channel_service"
      },
      {
        "step": 2,
        "title": "创建 ChannelController 和路由",
        "description": "实现 7 个 API 端点",
        "modification_points": [
          "创建 2 个文件: [backend/src/controllers/channel.controller.ts (180 行), backend/src/routes/channel.route.ts (70 行)]",
          "实现权限检查: ADMIN 全部权限, AGENT 只能查看自己的渠道"
        ],
        "logic_flow": [
          "channel.controller.ts: 导入 ChannelService",
          "getAll: query 参数 {tree: boolean, page, limit}, 调用 ChannelService.getAll",
          "如果 req.user.role === AGENT: 过滤 channelId === req.user.channelId",
          "getById: 权限检查 (AGENT 只能查看自己渠道), 调用 ChannelService.getById",
          "create: 权限检查 (仅 ADMIN), 请求校验, 调用 ChannelService.create",
          "update: 权限检查, 调用 ChannelService.update",
          "delete: 权限检查 (仅 ADMIN), 调用 ChannelService.delete",
          "channel.route.ts: 定义 7 个路由, 应用 authMiddleware"
        ],
        "depends_on": [1],
        "output": "channel_endpoints"
      },
      {
        "step": 3,
        "title": "创建请求校验 Schema",
        "description": "定义 Zod Schema",
        "modification_points": [
          "创建 1 个文件: backend/src/validators/channel.validator.ts (60 行)",
          "定义 2 个 Schema: [createChannelSchema (name, level, parentId, code, contactPerson, contactPhone), updateChannelSchema (部分字段可选)]"
        ],
        "logic_flow": [
          "createChannelSchema: z.object({name: z.string().min(2), level: z.number().int().min(1).max(4), parentId: z.string().uuid().optional(), code: z.string(), contactPerson: z.string(), contactPhone: z.string()})",
          "updateChannelSchema: createChannelSchema.partial().omit({level})",
          "导出 validator 中间件应用到路由"
        ],
        "depends_on": [2],
        "output": "validation"
      },
      {
        "step": 4,
        "title": "实现前端 channelService",
        "description": "封装渠道 API 调用",
        "modification_points": [
          "修改 1 个文件: frontend/src/services/channelService.ts (替换占位代码, 100 行)",
          "实现 7 个方法: 对应后端 7 个 API"
        ],
        "logic_flow": [
          "getChannels(params: {tree?: boolean, page?, limit?}): GET /channels",
          "getChannelById(id): GET /channels/:id",
          "createChannel(data): POST /channels",
          "updateChannel(id, data): PUT /channels/:id",
          "deleteChannel(id): DELETE /channels/:id",
          "getChildren(id): GET /channels/:id/children",
          "moveChannel(id, newParentId): PUT /channels/:id/move"
        ],
        "depends_on": [],
        "output": "channel_service_frontend"
      },
      {
        "step": 5,
        "title": "实现前端 ChannelsPage",
        "description": "构建渠道管理页面",
        "modification_points": [
          "修改 1 个文件: frontend/src/pages/ChannelsPage.tsx (替换占位代码, 350 行)",
          "实现 5 个组件: [ChannelTree (Ant Design Tree), CreateChannelModal (Form), EditChannelModal (Form), DeleteConfirm (Popconfirm), Toolbar (搜索+按钮)]"
        ],
        "logic_flow": [
          "使用 useQuery 获取渠道树形数据 (channelService.getChannels({tree: true}))",
          "渲染 Ant Design Tree 组件 (treeData from query.data)",
          "Tree 节点显示: 渠道名称 + 层级标签 + 操作按钮 (编辑/删除)",
          "Toolbar: 搜索框 (前端过滤), '创建渠道' 按钮 (仅 ADMIN 可见)",
          "CreateChannelModal: Form 表单 (name, level, parentId select tree, code, contact)",
          "parentId 字段: TreeSelect 组件选择父渠道",
          "useMutation 调用 channelService.createChannel",
          "成功后: message.success, 关闭 Modal, 刷新列表 (queryClient.invalidateQueries)",
          "EditChannelModal: 类似 Create, 预填充数据",
          "DeleteConfirm: Popconfirm 确认删除, useMutation 调用 deleteChannel"
        ],
        "depends_on": [4],
        "output": "channels_page"
      },
      {
        "step": 6,
        "title": "实现权限控制 HOC",
        "description": "创建权限检查高阶组件",
        "modification_points": [
          "创建 2 个文件: [frontend/src/components/common/PermissionGuard.tsx (50 行), frontend/src/hooks/usePermission.ts (40 行)]",
          "实现基于角色的 UI 权限控制"
        ],
        "logic_flow": [
          "usePermission hook: 从 authStore 读取 user.role, 导出 {isAdmin, isAgent, hasPermission(permission)}",
          "PermissionGuard 组件: 接收 requiredRole prop, 检查 user.role, 不满足则不渲染 children",
          "在 ChannelsPage 使用: <PermissionGuard requiredRole='ADMIN'><Button>创建渠道</Button></PermissionGuard>"
        ],
        "depends_on": [5],
        "output": "permission_control"
      },
      {
        "step": 7,
        "title": "优化树形数据展示",
        "description": "添加搜索、展开/收起、图标",
        "modification_points": [
          "修改 1 个文件: frontend/src/pages/ChannelsPage.tsx (+80 行)",
          "实现 3 个功能: [搜索过滤 (高亮匹配节点), 全部展开/收起, 层级图标 (不同颜色)]"
        ],
        "logic_flow": [
          "搜索功能: useState searchValue, 过滤树节点 (递归查找包含关键字的节点)",
          "展开/收起: useState expandedKeys, 按钮切换全部展开/收起",
          "层级图标: 根据 level 显示不同图标 (Ant Design Icons: CrownOutlined, ShopOutlined, UserOutlined, TeamOutlined)",
          "层级颜色: Tag 组件显示层级 (总代理-金色, 区域-蓝色, 一级-绿色, 二级-灰色)"
        ],
        "depends_on": [5],
        "output": "tree_optimization"
      },
      {
        "step": 8,
        "title": "集成测试",
        "description": "测试渠道 CRUD 和权限",
        "modification_points": [
          "执行 8 个测试用例: [创建总代理, 创建子渠道, 编辑渠道, 删除渠道, AGENT 权限限制, 树形展示, 搜索过滤, 移动节点]"
        ],
        "logic_flow": [
          "后端测试: Postman 测试所有 API 端点",
          "创建总代理 (level=1, parentId=null)",
          "创建区域代理 (level=2, parentId=总代理ID)",
          "测试权限: 使用 AGENT token 访问, 验证只能查看自己渠道",
          "前端测试: 以 ADMIN 登录",
          "创建渠道: 填写表单提交, 验证树中新增节点",
          "编辑渠道: 点击编辑按钮, 修改名称, 验证更新",
          "删除渠道: 点击删除, 确认, 验证节点消失",
          "搜索测试: 输入关键字, 验证过滤结果",
          "权限测试: 以 AGENT 登录, 验证 '创建渠道' 按钮不可见"
        ],
        "depends_on": [2, 6, 7],
        "output": "test_results"
      }
    ],
    "target_files": [
      "backend/src/services/channel.service.ts",
      "backend/src/controllers/channel.controller.ts",
      "backend/src/routes/channel.route.ts",
      "backend/src/validators/channel.validator.ts",
      "frontend/src/services/channelService.ts",
      "frontend/src/pages/ChannelsPage.tsx",
      "frontend/src/components/common/PermissionGuard.tsx",
      "frontend/src/hooks/usePermission.ts"
    ]
  }
}
