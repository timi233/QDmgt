{
  "id": "IMPL-014",
  "title": "性能优化与监控（Redis缓存 + 查询优化）",
  "status": "pending",
  "meta": {
    "type": "optimization",
    "agent": "@code-developer",
    "sprint": 3,
    "priority": "medium",
    "estimated_hours": 16
  },
  "context": {
    "requirements": [
      "实现 3 个缓存策略: [热点数据缓存 (产品、渠道), 分析结果缓存 (15分钟), 用户权限缓存 (30分钟)]",
      "优化 5 个慢查询: [渠道树查询, 订单列表查询, 产品库存查询, 分析聚合查询, 权限检查查询]",
      "实现 1 个性能监控: API 响应时间记录和告警",
      "前端优化 3 个方面: [代码分割, 虚拟滚动, 图片懒加载]",
      "配置 1 个数据库连接池: Prisma 连接池优化"
    ],
    "focus_paths": [
      "backend/src/utils/cache.ts",
      "backend/src/middlewares/performanceMonitor.ts",
      "frontend/src/utils/lazyLoad.ts"
    ],
    "acceptance": [
      "缓存命中率 > 70%: 验证 Redis 缓存生效",
      "API 响应时间 < 200ms (P95): 验证性能优化效果",
      "前端首屏加载 < 2s: 验证代码分割和懒加载",
      "数据库连接数 < 20: 验证连接池配置",
      "监控数据可视化: 验证可以查看性能指标"
    ],
    "depends_on": ["IMPL-012"],
    "artifacts": []
  },
  "flow_control": {
    "pre_analysis": [],
    "implementation_approach": [
      {
        "step": 1,
        "title": "创建 Redis 缓存工具",
        "description": "封装缓存 get/set/delete 操作",
        "modification_points": [
          "创建 1 个文件: backend/src/utils/cache.ts (150 行)",
          "实现 5 个方法: [get, set, del, exists, ttl]",
          "实现 2 个装饰器: [@Cacheable (自动缓存), @CacheEvict (清除缓存)]"
        ],
        "logic_flow": [
          "导入 Redis client (from config/redis.ts)",
          "get(key): redis.get(key), 自动 JSON.parse",
          "set(key, value, ttl?): redis.setex(key, ttl, JSON.stringify(value))",
          "del(key): redis.del(key)",
          "exists(key): redis.exists(key)",
          "ttl(key): redis.ttl(key)",
          "@Cacheable 装饰器: 方法执行前检查缓存, 命中则返回, 未命中则执行并缓存",
          "@CacheEvict 装饰器: 方法执行后清除指定 key 缓存"
        ],
        "depends_on": [],
        "output": "cache_utils"
      },
      {
        "step": 2,
        "title": "应用缓存到热点数据",
        "description": "为产品、渠道、权限添加缓存",
        "modification_points": [
          "修改 3 个文件: [product.service.ts, channel.service.ts, permission.service.ts]",
          "为 getAll, getById 方法添加 @Cacheable 装饰器"
        ],
        "logic_flow": [
          "ProductService.getAll: @Cacheable('products:all', 300) // 5分钟",
          "ProductService.getById: @Cacheable('product:{id}', 600) // 10分钟",
          "ChannelService.getAll: @Cacheable('channels:all', 300)",
          "PermissionService.getUserPermissions: @Cacheable('permissions:user:{userId}', 1800) // 30分钟",
          "create/update/delete 方法: @CacheEvict 清除对应缓存"
        ],
        "depends_on": [1],
        "output": "hot_data_cache"
      },
      {
        "step": 3,
        "title": "优化数据库查询",
        "description": "添加索引和优化查询语句",
        "modification_points": [
          "修改 1 个文件: backend/prisma/schema.prisma (添加复合索引, +20 行)",
          "优化 5 个 Service 方法: 使用 select, include 减少查询字段"
        ],
        "logic_flow": [
          "添加复合索引:",
          "Order: @@index([channelId, createdAt])",
          "Order: @@index([status, createdAt])",
          "OrderItem: @@index([productId, orderId])",
          "AuditLog: @@index([entity, entityId, createdAt])",
          "优化查询:",
          "OrderService.getAll: 使用 select 只查询必要字段, 避免查询 items",
          "ChannelService.getAll (tree=false): 不查询 children 关系",
          "ProductService.getAll: 不查询 pricingRules 关系",
          "执行迁移: npx prisma migrate dev --name add_performance_indexes"
        ],
        "depends_on": [],
        "output": "query_optimization"
      },
      {
        "step": 4,
        "title": "配置数据库连接池",
        "description": "优化 Prisma 连接池参数",
        "modification_points": [
          "修改 1 个文件: backend/src/utils/prisma.ts (添加连接池配置, +15 行)"
        ],
        "logic_flow": [
          "配置 Prisma Client:",
          "new PrismaClient({",
          "  datasources: {db: {url: DATABASE_URL}},",
          "  log: ['query', 'error', 'warn'],",
          "  // 连接池配置",
          "  connectionLimit: 20, // 最大连接数",
          "  pool: {min: 5, max: 20, idleTimeoutMillis: 30000}",
          "})",
          "添加连接池监控: 记录活跃连接数"
        ],
        "depends_on": [],
        "output": "connection_pool"
      },
      {
        "step": 5,
        "title": "实现性能监控中间件",
        "description": "记录 API 响应时间",
        "modification_points": [
          "创建 1 个文件: backend/src/middlewares/performanceMonitor.ts (100 行)",
          "集成到 app.ts"
        ],
        "logic_flow": [
          "中间件逻辑:",
          "1. 记录请求开始时间 (startTime)",
          "2. 调用 next()",
          "3. 记录请求结束时间 (endTime)",
          "4. 计算响应时间 (duration = endTime - startTime)",
          "5. 记录到日志: logger.info({method, path, duration, statusCode})",
          "6. 如果 duration > 1000ms: 记录为慢查询警告",
          "7. 存储到 Redis (时间序列): redis.zadd('api:metrics', timestamp, {path, duration})",
          "8. 设置响应头: X-Response-Time: {duration}ms",
          "在 app.ts 应用中间件 (在路由之前)"
        ],
        "depends_on": [],
        "output": "performance_monitor"
      },
      {
        "step": 6,
        "title": "创建性能监控 API",
        "description": "查询性能指标",
        "modification_points": [
          "创建 2 个文件: [backend/src/controllers/metrics.controller.ts (80 行), backend/src/routes/metrics.route.ts (30 行)]",
          "实现 3 个端点: [GET /metrics/api-performance, GET /metrics/cache-stats, GET /metrics/db-stats]"
        ],
        "logic_flow": [
          "getApiPerformance: 从 Redis 读取 api:metrics (最近 1000 条)",
          "计算平均响应时间、P50、P95、P99",
          "按 path 分组统计",
          "getCacheStats: Redis info stats (命中率、内存使用)",
          "getDbStats: Prisma 连接池状态 (活跃连接、空闲连接)",
          "权限: 仅 SUPER_ADMIN 可访问"
        ],
        "depends_on": [5],
        "output": "metrics_api"
      },
      {
        "step": 7,
        "title": "前端代码分割",
        "description": "使用 React.lazy 和 Suspense",
        "modification_points": [
          "修改 1 个文件: frontend/src/router/index.tsx (重构路由, 使用 lazy, +50 行)"
        ],
        "logic_flow": [
          "导入 React.lazy 和 Suspense",
          "懒加载所有页面组件:",
          "const ChannelsPage = React.lazy(() => import('@/pages/ChannelsPage'))",
          "const ProductsPage = React.lazy(() => import('@/pages/ProductsPage'))",
          "const OrdersPage = React.lazy(() => import('@/pages/OrdersPage'))",
          "const InventoryPage = React.lazy(() => import('@/pages/InventoryPage'))",
          "const DashboardPage = React.lazy(() => import('@/pages/DashboardPage'))",
          "使用 Suspense 包裹:",
          "<Suspense fallback={<LoadingSpinner />}><Outlet /></Suspense>",
          "验证: 构建后查看 dist/ 生成的 chunk 文件"
        ],
        "depends_on": [],
        "output": "code_splitting"
      },
      {
        "step": 8,
        "title": "前端虚拟滚动",
        "description": "大数据列表使用虚拟滚动",
        "modification_points": [
          "安装依赖: npm install react-window",
          "修改 2 个文件: [ProductsPage.tsx, OrdersPage.tsx] (使用 FixedSizeList)"
        ],
        "logic_flow": [
          "导入 react-window: import {FixedSizeList} from 'react-window'",
          "替换 Ant Design Table 为虚拟滚动表格:",
          "<FixedSizeList",
          "  height={600}",
          "  itemCount={products.length}",
          "  itemSize={50}",
          "  width='100%'",
          ">",
          "  {({index, style}) => <div style={style}>{renderRow(products[index])}</div>}",
          "</FixedSizeList>",
          "适用于超过 100 行的列表"
        ],
        "depends_on": [],
        "output": "virtual_scrolling"
      },
      {
        "step": 9,
        "title": "前端图片懒加载",
        "description": "产品图片懒加载",
        "modification_points": [
          "创建 1 个组件: frontend/src/components/common/LazyImage.tsx (60 行)",
          "使用 Intersection Observer API"
        ],
        "logic_flow": [
          "LazyImage 组件:",
          "Props: {src, alt, placeholder}",
          "useState: {loaded: false, inView: false}",
          "useEffect: 创建 IntersectionObserver 监听图片是否进入视口",
          "如果进入视口: setInView(true), 加载图片",
          "渲染: inView ? <img src={src} onLoad={() => setLoaded(true)} /> : <img src={placeholder} />",
          "应用到 ProductsPage 产品图片"
        ],
        "depends_on": [],
        "output": "lazy_loading"
      },
      {
        "step": 10,
        "title": "创建性能监控页面",
        "description": "前端展示性能指标",
        "modification_points": [
          "创建 1 个文件: frontend/src/pages/MetricsPage.tsx (250 行)",
          "展示 API 性能、缓存统计、数据库统计"
        ],
        "logic_flow": [
          "使用 useQuery 获取 3 个指标:",
          "1. metricsService.getApiPerformance (折线图: 响应时间趋势)",
          "2. metricsService.getCacheStats (饼图: 缓存命中率)",
          "3. metricsService.getDbStats (仪表盘: 数据库连接数)",
          "布局: 3 个 Card, 每个包含一个图表",
          "使用 @ant-design/charts",
          "仅 SUPER_ADMIN 可访问",
          "添加到侧边栏菜单"
        ],
        "depends_on": [6],
        "output": "metrics_page"
      },
      {
        "step": 11,
        "title": "测试",
        "description": "测试性能优化效果",
        "modification_points": [
          "执行 7 个测试: [缓存命中率, API 响应时间, 慢查询告警, 前端加载时间, 虚拟滚动, 懒加载, 监控页面]"
        ],
        "logic_flow": [
          "缓存测试: 第一次请求 GET /products, 第二次请求验证从缓存返回 (检查响应头或日志)",
          "计算缓存命中率 (Redis hits / (hits + misses))",
          "性能测试: 使用 Apache Bench 或 Artillery 压测",
          "ab -n 1000 -c 10 http://localhost:4000/api/v1/products",
          "验证 P95 响应时间 < 200ms",
          "慢查询测试: 故意查询复杂数据, 验证日志记录警告",
          "前端测试: npm run build, 使用 Lighthouse 测试首屏加载时间",
          "验证 FCP < 1.5s, LCP < 2.5s",
          "虚拟滚动测试: 加载 1000 个产品, 验证滚动流畅",
          "懒加载测试: 检查 Network 面板, 验证图片按需加载",
          "监控页面测试: 以 SUPER_ADMIN 登录, 访问 /metrics, 验证图表显示"
        ],
        "depends_on": [2, 3, 4, 5, 6, 7, 8, 9, 10],
        "output": "test_results"
      }
    ],
    "target_files": [
      "backend/src/utils/cache.ts",
      "backend/src/config/redis.ts",
      "backend/src/services/product.service.ts",
      "backend/src/services/channel.service.ts",
      "backend/src/services/permission.service.ts",
      "backend/prisma/schema.prisma",
      "backend/src/utils/prisma.ts",
      "backend/src/middlewares/performanceMonitor.ts",
      "backend/src/controllers/metrics.controller.ts",
      "backend/src/routes/metrics.route.ts",
      "backend/src/app.ts",
      "frontend/src/router/index.tsx",
      "frontend/src/pages/ProductsPage.tsx",
      "frontend/src/pages/OrdersPage.tsx",
      "frontend/src/components/common/LazyImage.tsx",
      "frontend/src/services/metricsService.ts",
      "frontend/src/pages/MetricsPage.tsx"
    ]
  }
}
