{
  "id": "IMPL-011",
  "title": "库存管理模块（实时同步 + 预警）",
  "status": "pending",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "sprint": 3,
    "priority": "high",
    "estimated_hours": 16
  },
  "context": {
    "requirements": [
      "实现 5 个后端 API: [GET /inventory, GET /inventory/:productId, PUT /inventory/:productId/adjust, GET /inventory/alerts, POST /inventory/transfer]",
      "创建 1 个 InventoryService: 5 个方法 (查询, 调整, 预警检查, 库存转移, 库存日志)",
      "实现 1 个预警机制: 库存低于阈值时自动生成预警 (使用 Redis pub/sub 或定时任务)",
      "前端实现 4 个功能: [库存列表, 库存调整 Modal, 预警列表, 库存变动日志]",
      "创建 1 个审计表: InventoryLog 记录所有库存变动"
    ],
    "focus_paths": [
      "backend/src/services/inventory.service.ts",
      "backend/src/controllers/inventory.controller.ts",
      "frontend/src/pages/InventoryPage.tsx"
    ],
    "acceptance": [
      "5 个 API 正常工作: 验证所有端点",
      "库存调整成功: 验证可以增加/减少库存并记录日志",
      "预警机制生效: 验证库存低于阈值时生成预警",
      "前端实时显示: 验证库存变动后页面自动刷新",
      "审计日志完整: 验证所有变动都有日志记录"
    ],
    "depends_on": ["IMPL-009"],
    "artifacts": []
  },
  "flow_control": {
    "pre_analysis": [],
    "implementation_approach": [
      {
        "step": 1,
        "title": "扩展数据模型",
        "description": "添加 InventoryLog 表",
        "modification_points": [
          "修改 1 个文件: backend/prisma/schema.prisma (添加 InventoryLog model, +20 行)",
          "定义 InventoryLog: {id, productId, type (ADJUST/DEDUCT/TRANSFER), quantity, beforeStock, afterStock, reason, operatorId, createdAt}",
          "执行 1 次迁移: npx prisma migrate dev --name add_inventory_log"
        ],
        "logic_flow": [
          "添加 InventoryLog model",
          "type 枚举: ADJUST (手工调整), DEDUCT (订单扣减), TRANSFER (库存转移)",
          "关联 Product (productId) 和 User (operatorId)",
          "执行迁移生成表"
        ],
        "depends_on": [],
        "output": "schema_update"
      },
      {
        "step": 2,
        "title": "创建 InventoryService",
        "description": "实现库存业务逻辑",
        "modification_points": [
          "创建 1 个文件: backend/src/services/inventory.service.ts (280 行)",
          "实现 5 个方法: [getInventory, adjustStock, checkAlerts, transferStock, getStockLogs]"
        ],
        "logic_flow": [
          "getInventory: 查询所有产品库存, 支持过滤 (低库存, 缺货)",
          "adjustStock(productId, quantity, reason, operatorId):",
          "1. Prisma.transaction",
          "2. 查询当前库存 (beforeStock)",
          "3. 计算新库存 (afterStock = beforeStock + quantity)",
          "4. 更新 Product.stock",
          "5. 创建 InventoryLog",
          "6. 调用 checkAlerts 检查是否需要预警",
          "checkAlerts(productId):",
          "1. 查询 Product.stock 和预警阈值 (可配置, 默认 10)",
          "2. 如果 stock < threshold: 返回预警信息 {productId, stock, threshold}",
          "transferStock: 类似 adjustStock, 但记录 type = TRANSFER",
          "getStockLogs: 查询 InventoryLog, 支持过滤 (productId, type)"
        ],
        "depends_on": [1],
        "output": "inventory_service"
      },
      {
        "step": 3,
        "title": "创建 InventoryController 和路由",
        "description": "实现 5 个 API 端点",
        "modification_points": [
          "创建 2 个文件: [backend/src/controllers/inventory.controller.ts (150 行), backend/src/routes/inventory.route.ts (50 行)]"
        ],
        "logic_flow": [
          "getInventory: GET /inventory, query: {lowStock: boolean}",
          "getProductInventory: GET /inventory/:productId (包含库存日志)",
          "adjustStock: PUT /inventory/:productId/adjust, body: {quantity, reason}",
          "getAlerts: GET /inventory/alerts (返回所有低库存产品)",
          "transferStock: POST /inventory/transfer, body: {fromProductId, toProductId, quantity}",
          "权限: 调整库存仅 ADMIN"
        ],
        "depends_on": [2],
        "output": "inventory_endpoints"
      },
      {
        "step": 4,
        "title": "实现预警定时任务",
        "description": "定时检查库存并生成预警",
        "modification_points": [
          "创建 1 个文件: backend/src/jobs/inventory-check.job.ts (60 行)",
          "使用 node-cron 定时任务 (每小时执行一次)"
        ],
        "logic_flow": [
          "导入 node-cron",
          "定义定时任务: cron.schedule('0 * * * *', async () => {...})",
          "任务逻辑:",
          "1. 查询所有 ACTIVE 产品",
          "2. 过滤 stock < threshold 的产品",
          "3. 生成预警列表",
          "4. 存储到 Redis (key: inventory:alerts, expire: 1小时)",
          "5. (可选) 发送通知 (邮件/WebSocket)",
          "在 server.ts 启动时注册定时任务"
        ],
        "depends_on": [2],
        "output": "alert_job"
      },
      {
        "step": 5,
        "title": "实现前端库存管理页面",
        "description": "库存列表和调整功能",
        "modification_points": [
          "创建 1 个文件: frontend/src/pages/InventoryPage.tsx (350 行)",
          "实现 Table + 调整 Modal + 预警提示"
        ],
        "logic_flow": [
          "InventoryTable: columns [产品SKU, 名称, 当前库存, 预警状态, 操作]",
          "预警状态: 库存 < 10 显示红色 Badge '低库存'",
          "useQuery 获取库存列表",
          "筛选栏: Switch '仅显示低库存'",
          "操作列: '调整库存' 按钮",
          "AdjustStockModal: Form {quantity (可正可负), reason (TextArea)}",
          "提交: useMutation 调用 inventoryService.adjustStock",
          "成功后: message.success, 刷新列表",
          "页面顶部: Alert 组件显示预警数量 (如: '3 个产品库存不足')",
          "点击 Alert 跳转到低库存列表"
        ],
        "depends_on": [],
        "output": "inventory_page"
      },
      {
        "step": 6,
        "title": "实现库存日志组件",
        "description": "展示库存变动历史",
        "modification_points": [
          "创建 1 个文件: frontend/src/components/business/InventoryLogDrawer.tsx (150 行)",
          "使用 Ant Design Drawer 组件"
        ],
        "logic_flow": [
          "Drawer 标题: '库存变动日志 - {产品名称}'",
          "useQuery 获取日志列表 (inventoryService.getStockLogs(productId))",
          "Timeline 组件展示日志:",
          "每个节点: {时间, 类型, 操作人, 数量变化 (+/-, 绿/红), 原因}",
          "类型图标: ADJUST-EditOutlined, DEDUCT-ShoppingOutlined, TRANSFER-SwapOutlined",
          "在 InventoryPage 每行添加 '查看日志' 按钮打开 Drawer"
        ],
        "depends_on": [5],
        "output": "inventory_log"
      },
      {
        "step": 7,
        "title": "集成实时库存到订单",
        "description": "订单页面显示实时库存",
        "modification_points": [
          "修改 1 个文件: frontend/src/components/business/CreateOrderModal.tsx (添加库存显示, +30 行)"
        ],
        "logic_flow": [
          "在产品 Select 选项中显示库存 (label: '{产品名称} (库存: {stock})')",
          "选择产品后, 显示库存提示",
          "quantity InputNumber max 属性 = 当前库存",
          "如果库存不足: 禁用提交按钮, 显示警告"
        ],
        "depends_on": [5],
        "output": "inventory_integration"
      },
      {
        "step": 8,
        "title": "测试",
        "description": "测试库存管理全流程",
        "modification_points": [
          "执行 7 个测试: [库存调整, 订单扣减, 库存日志, 预警生成, 前端展示, 实时刷新, 权限控制]"
        ],
        "logic_flow": [
          "后端测试: 调整库存 (quantity: +50), 验证 stock 增加, 日志生成",
          "订单扣减测试: 创建并完成订单, 验证库存减少, 日志 type = DEDUCT",
          "预警测试: 调整库存至 5, 验证预警生成",
          "定时任务测试: 触发定时任务, 验证 Redis 存储预警",
          "前端测试: 调整库存, 验证表格刷新",
          "查看日志: 打开 Drawer, 验证日志完整",
          "订单创建: 验证库存不足时提示",
          "权限测试: AGENT 登录, 验证无法调整库存"
        ],
        "depends_on": [3, 4, 6, 7],
        "output": "test_results"
      }
    ],
    "target_files": [
      "backend/prisma/schema.prisma",
      "backend/src/services/inventory.service.ts",
      "backend/src/controllers/inventory.controller.ts",
      "backend/src/routes/inventory.route.ts",
      "backend/src/jobs/inventory-check.job.ts",
      "backend/src/server.ts",
      "frontend/src/services/inventoryService.ts",
      "frontend/src/pages/InventoryPage.tsx",
      "frontend/src/components/business/InventoryLogDrawer.tsx",
      "frontend/src/components/business/CreateOrderModal.tsx"
    ]
  }
}
