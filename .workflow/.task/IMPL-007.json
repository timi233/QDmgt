{
  "id": "IMPL-007",
  "title": "产品管理模块",
  "status": "pending",
  "meta": {
    "type": "feature",
    "agent": "@code-developer",
    "sprint": 2,
    "priority": "high",
    "estimated_hours": 16
  },
  "context": {
    "requirements": [
      "实现 6 个后端 API: [GET /products, GET /products/:id, POST /products, PUT /products/:id, DELETE /products/:id, POST /products/batch-import]",
      "创建 1 个 ProductService: 6 个方法 (CRUD + 批量导入)",
      "前端实现 5 个功能: [产品列表表格, 创建产品 Modal, 编辑产品 Modal, 批量导入 (Excel), 库存显示]",
      "实现 1 个批量导入: 支持 Excel 文件解析和批量创建",
      "集成 1 个文件上传: 产品图片上传 (可选)"
    ],
    "focus_paths": [
      "backend/src/services/product.service.ts",
      "backend/src/controllers/product.controller.ts",
      "frontend/src/pages/ProductsPage.tsx"
    ],
    "acceptance": [
      "6 个 API 正常工作: 验证 CRUD 和批量导入",
      "前端表格展示: 验证分页、排序、筛选",
      "创建产品成功: 验证表单提交并刷新列表",
      "批量导入成功: 验证上传 Excel 后批量创建产品",
      "SKU 唯一性校验: 验证重复 SKU 提示错误"
    ],
    "depends_on": ["IMPL-006"],
    "artifacts": []
  },
  "flow_control": {
    "pre_analysis": [],
    "implementation_approach": [
      {
        "step": 1,
        "title": "创建 ProductService",
        "description": "实现产品业务逻辑",
        "modification_points": [
          "创建 1 个文件: backend/src/services/product.service.ts (200 行)",
          "实现 6 个方法: [getAll(分页+筛选), getById, create(校验SKU唯一), update, delete(软删除), batchImport(解析Excel)]"
        ],
        "logic_flow": [
          "getAll: Prisma 查询, 支持分页 (page, limit), 过滤 (status, keyword)",
          "getById: Prisma findUnique, 包含 pricingRules 关系",
          "create: 校验 SKU 唯一性, Prisma create",
          "update: 校验 SKU (如果修改), Prisma update",
          "delete: 软删除 (status = INACTIVE)",
          "batchImport: 接收解析后的数据数组, 批量 Prisma createMany, 跳过重复 SKU"
        ],
        "depends_on": [],
        "output": "product_service"
      },
      {
        "step": 2,
        "title": "创建 ProductController 和路由",
        "description": "实现 6 个 API 端点",
        "modification_points": [
          "创建 2 个文件: [backend/src/controllers/product.controller.ts (150 行), backend/src/routes/product.route.ts (60 行)]",
          "集成文件上传中间件: multer (仅 ADMIN 可批量导入)"
        ],
        "logic_flow": [
          "product.controller.ts: getAll, getById, create, update, delete (类似 ChannelController)",
          "batchImport: 使用 multer 处理 Excel 文件上传, 使用 xlsx 库解析, 调用 ProductService.batchImport",
          "权限检查: 创建/编辑/删除仅 ADMIN",
          "product.route.ts: 定义 6 个路由, POST /batch-import 使用 multer middleware"
        ],
        "depends_on": [1],
        "output": "product_endpoints"
      },
      {
        "step": 3,
        "title": "实现前端 ProductsPage",
        "description": "产品列表和 CRUD",
        "modification_points": [
          "修改 1 个文件: frontend/src/pages/ProductsPage.tsx (替换占位, 300 行)",
          "实现 4 个组件: [ProductTable, CreateModal, EditModal, BatchImportModal]"
        ],
        "logic_flow": [
          "ProductTable: Ant Design Table, columns: [SKU, 名称, 基础价格, 库存, 状态, 操作]",
          "useQuery 获取产品列表, 分页参数",
          "CreateModal: Form (sku, name, description, basePrice, stock)",
          "EditModal: 预填充数据",
          "BatchImportModal: Upload 组件 (Ant Design Upload), 上传 Excel, useMutation 调用 batchImport API",
          "下载模板按钮: 下载 Excel 模板文件"
        ],
        "depends_on": [],
        "output": "products_page"
      },
      {
        "step": 4,
        "title": "实现批量导入功能",
        "description": "Excel 解析和上传",
        "modification_points": [
          "后端安装依赖: xlsx (npm install xlsx)",
          "前端创建 Excel 模板生成函数",
          "实现 Excel 文件校验 (格式、必填字段)"
        ],
        "logic_flow": [
          "后端: batchImport controller 使用 xlsx.read 解析 buffer",
          "提取 sheet 数据转为 JSON 数组",
          "校验必填字段 (sku, name, basePrice)",
          "调用 ProductService.batchImport",
          "前端: BatchImportModal Upload 组件 beforeUpload 校验文件类型",
          "customRequest 使用 FormData 上传",
          "成功后: message.success, invalidateQueries 刷新列表"
        ],
        "depends_on": [2, 3],
        "output": "batch_import"
      },
      {
        "step": 5,
        "title": "测试",
        "description": "测试产品 CRUD 和批量导入",
        "modification_points": [
          "执行 6 个测试: [创建产品, 编辑产品, 删除产品, SKU 唯一性, 批量导入, 列表分页]"
        ],
        "logic_flow": [
          "后端测试: Postman 测试所有 API",
          "前端测试: 创建产品, 验证表格新增",
          "批量导入测试: 上传包含 10 个产品的 Excel, 验证批量创建",
          "SKU 冲突测试: 创建重复 SKU, 验证错误提示"
        ],
        "depends_on": [4],
        "output": "test_results"
      }
    ],
    "target_files": [
      "backend/src/services/product.service.ts",
      "backend/src/controllers/product.controller.ts",
      "backend/src/routes/product.route.ts",
      "backend/src/validators/product.validator.ts",
      "frontend/src/services/productService.ts",
      "frontend/src/pages/ProductsPage.tsx"
    ]
  }
}
