# Dockerå®¹å™¨åŒ–å®æ–½æ—¥å¿—

**æ—¥æœŸ:** 2025-10-20  
**ä»»åŠ¡:** å°†QDmgtç³»ç»Ÿå®¹å™¨åŒ–ï¼Œæ”¯æŒè·¨æœºå™¨éƒ¨ç½²  
**ç›®æ ‡:** PostgreSQLå®¹å™¨åŒ– + ä¸€é”®éƒ¨ç½²åˆ°192.168.101.9

---

## ğŸ“‹ éœ€æ±‚åˆ†æ

### åŸå§‹éœ€æ±‚
1. å°†ç³»ç»Ÿæ‰“åŒ…æˆå®¹å™¨ç¯å¢ƒ
2. æ”¯æŒä¸€é”®éƒ¨ç½²åˆ°å…¶ä»–æœºå™¨ï¼ˆ192.168.101.9ï¼‰
3. å®¹å™¨ä¸æœ¬åœ°æ–‡ä»¶å¯ç”¨æŒä¹…åŒ–ï¼ˆä½¿ç”¨bind mountè€ŒéCOPYï¼‰
4. CORSé…ç½®æ”¯æŒå¤šä¸ªè®¿é—®åœ°å€
5. **æ•°æ®åº“ä»SQLiteå‡çº§åˆ°PostgreSQL**
6. **PostgreSQLæ”¾ç½®åœ¨å†…éƒ¨ç½‘ç»œï¼Œä¸å¯¹å¤–æš´éœ²ç«¯å£**

### Linusä¸‰é—®åˆ†æ
1. **æ˜¯çœŸå®é—®é¢˜å—ï¼Ÿ** âœ“ æ˜¯çš„ã€‚éœ€è¦è·¨æœºå™¨éƒ¨ç½²ï¼Œå®¹å™¨åŒ–æ˜¯æ ‡å‡†æ–¹æ¡ˆã€‚
2. **æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ** Docker Compose + bind mount + managed volumeæ˜¯æœ€ç®€æ´æ–¹æ¡ˆã€‚
3. **ä¼šç ´åä»€ä¹ˆï¼Ÿ** éœ€è¦æ•°æ®è¿ç§»ï¼ˆSQLiteâ†’PostgreSQLï¼‰ï¼Œä½†æä¾›äº†è¿ç§»å·¥å…·ã€‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### å®¹å™¨æ¶æ„
```
å¤–éƒ¨è®¿é—® (192.168.101.9)
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend (Nginx)          â”‚  Port: 3002 â†’ å®¿ä¸»æœº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend (FastAPI)         â”‚  Port: 8001 â†’ å®¿ä¸»æœº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ (å†…éƒ¨ç½‘ç»œ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL                â”‚  Port: 5432 (ä»…å†…éƒ¨)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    Docker Volume
```

### å…³é”®è®¾è®¡å†³ç­–

#### 1. PostgreSQLç½‘ç»œéš”ç¦»
- **å†³ç­–:** ä¸åœ¨docker-compose.ymlä¸­æš´éœ²PostgreSQLç«¯å£
- **å®ç°:** æ—  `ports:` é…ç½®ï¼Œä»…å†…éƒ¨ç½‘ç»œé€šä¿¡
- **è¿æ¥:** `postgresql://user:pass@postgres:5432/db`ï¼ˆå®¹å™¨DNSï¼‰

#### 2. æ•°æ®æŒä¹…åŒ–ç­–ç•¥
- **PostgreSQL:** Docker managed volumeï¼ˆé«˜æ€§èƒ½ï¼Œè·¨å¹³å°ï¼‰
- **åç«¯ä»£ç :** bind mountï¼ˆæ”¯æŒçƒ­æ›´æ–°ï¼‰
- **å‰ç«¯:** å¤šé˜¶æ®µæ„å»ºï¼ˆä¼˜åŒ–é•œåƒå¤§å°ï¼‰

#### 3. è‡ªåŠ¨åŒ–éƒ¨ç½²
- **æ•°æ®åº“è¿ç§»:** Alembicåœ¨å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ
- **å¥åº·æ£€æŸ¥:** æ‰€æœ‰æœåŠ¡é…ç½®å¥åº·æ£€æŸ¥
- **ä¾èµ–ç®¡ç†:** `depends_on` + health condition

---

## ğŸ› ï¸ å®æ–½è¿‡ç¨‹

### Phase 1: æ–‡ä»¶åˆ›å»ºï¼ˆ9ä¸ªï¼‰
1. âœ… `docker-compose.yml` - 3æœåŠ¡ç¼–æ’
2. âœ… `backend/Dockerfile` - åç«¯é•œåƒ
3. âœ… `frontend/Dockerfile` - å‰ç«¯é•œåƒ
4. âœ… `frontend/nginx.conf` - Nginxé…ç½®
5. âœ… `.env.docker.example` - ç¯å¢ƒå˜é‡æ¨¡æ¿
6. âœ… `docker-start.sh` - å¯åŠ¨è„šæœ¬
7. âœ… `docker-stop.sh` - åœæ­¢è„šæœ¬
8. âœ… `scripts/migrate-to-postgres.sh` - æ•°æ®è¿ç§»å·¥å…·
9. âœ… `docs/docker-deployment.md` + `DOCKER_QUICKSTART.md` - æ–‡æ¡£

### Phase 2: é—®é¢˜ä¿®å¤

#### é—®é¢˜1: Python 3.13å…¼å®¹æ€§
**é”™è¯¯ä¿¡æ¯:**
```
ERROR: Failed building wheel for asyncpg, psycopg2-binary, pydantic-core
```

**æ ¹æœ¬åŸå› :**
- Python 3.13å¤ªæ–°ï¼Œå¤šä¸ªåŒ…ä¸å…¼å®¹
- `pydantic-core` éœ€è¦ `ForwardRef._evaluate()` æ–°API
- `psycopg2-binary` ä½¿ç”¨äº†åºŸå¼ƒçš„ `_PyInterpreterState_Get()`

**è§£å†³æ–¹æ¡ˆ:**
```dockerfile
# ä¿®æ”¹å‰
FROM python:3.13-slim

# ä¿®æ”¹å
FROM python:3.11-slim
```

**ç†ç”±:**
- Python 3.11æˆç†Ÿç¨³å®šï¼Œå¹¿æ³›æ”¯æŒ
- æ‰€æœ‰ä¾èµ–åŒ…æœ‰é¢„ç¼–è¯‘wheel
- é•¿æœŸæ”¯æŒï¼ˆLTSï¼‰åˆ°2027å¹´

#### é—®é¢˜2: ç¼–è¯‘ä¾èµ–ç¼ºå¤±
**é”™è¯¯ä¿¡æ¯:**
```
fatal error: assert.h: No such file or directory
rust-lld: error: cannot open Scrt1.o
```

**æ ¹æœ¬åŸå› :**
- `python:3.11-slim` é•œåƒç§»é™¤äº†ç¼–è¯‘å·¥å…·
- `asyncpg`ã€`psycopg2-binary` éœ€è¦Cç¼–è¯‘å™¨
- `pydantic-core` éœ€è¦Rustç¼–è¯‘å™¨

**è§£å†³æ–¹æ¡ˆ:**
```dockerfile
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \    # gcc, g++, make, libc-devç­‰
        libpq-dev \          # PostgreSQLå®¢æˆ·ç«¯å¼€å‘åº“
        python3-dev \        # Python.hç­‰å¤´æ–‡ä»¶
        curl \               # å¥åº·æ£€æŸ¥
        rustc \              # Rustç¼–è¯‘å™¨
        cargo \              # RuståŒ…ç®¡ç†å™¨
    && rm -rf /var/lib/apt/lists/*
```

**å½±å“:**
- é•œåƒå¤§å°å¢åŠ çº¦200MBï¼ˆå¯æ¥å—ï¼‰
- æ„å»ºæ—¶é—´å¢åŠ çº¦30ç§’ï¼ˆä¸€æ¬¡æ€§æˆæœ¬ï¼‰

### Phase 3: éªŒè¯æµ‹è¯•
- âœ… åç«¯é•œåƒæ„å»ºæˆåŠŸï¼ˆ60ç§’ï¼‰
- âœ… æ‰€æœ‰ä¾èµ–åŒ…å®‰è£…æˆåŠŸ
- âœ… `.env.docker` é…ç½®å·²åˆ›å»º

---

## ğŸ“Š æœ€ç»ˆæˆæœ

### æ–‡ä»¶æ¸…å•
| æ–‡ä»¶ | å¤§å° | è¯´æ˜ |
|------|------|------|
| docker-compose.yml | 3.2KB | 3æœåŠ¡ç¼–æ’ |
| backend/Dockerfile | 1.9KB | Python 3.11 + ç¼–è¯‘å·¥å…· |
| frontend/Dockerfile | 1.5KB | Node 18 â†’ Nginx |
| frontend/nginx.conf | 1.9KB | SPAè·¯ç”±é…ç½® |
| .env.docker.example | 2.9KB | ç¯å¢ƒå˜é‡æ¨¡æ¿ |
| docker-start.sh | 5.6KB | ä¸€é”®å¯åŠ¨ |
| docker-stop.sh | 2.3KB | ä¸€é”®åœæ­¢ |
| scripts/migrate-to-postgres.sh | 6.2KB | æ•°æ®è¿ç§» |
| docs/docker-deployment.md | 14KB | å®Œæ•´æ–‡æ¡£ |
| DOCKER_QUICKSTART.md | 4.9KB | å¿«é€Ÿå¼€å§‹ |

### é•œåƒä¿¡æ¯
| é•œåƒ | åŸºç¡€é•œåƒ | å¤§å° | çŠ¶æ€ |
|------|---------|------|------|
| qdmgt_backend | python:3.11-slim | ~500MB | âœ… å·²æ„å»º |
| qdmgt_frontend | nginx:1.25-alpine | ~50MB | å¾…æ„å»º |
| qdmgt_postgres | postgres:15-alpine | ~240MB | å®˜æ–¹é•œåƒ |

### æŠ€æœ¯æ ˆ
- **åç«¯:** Python 3.11 + FastAPI + Uvicorn + Alembic
- **å‰ç«¯:** React 18 + TypeScript + Nginx 1.25
- **æ•°æ®åº“:** PostgreSQL 15
- **ç¼–æ’:** Docker Compose 2.0+

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### å®‰å…¨æ€§
- âœ… PostgreSQLä»…å†…éƒ¨ç½‘ç»œè®¿é—®ï¼ˆæ— ç«¯å£æš´éœ²ï¼‰
- âœ… érootç”¨æˆ·è¿è¡Œåº”ç”¨
- âœ… å®‰å…¨å¯†é’¥ç”Ÿæˆï¼ˆOpenSSL randomï¼‰
- âœ… CORSä¸¥æ ¼é…ç½®

### å¯é æ€§
- âœ… å¥åº·æ£€æŸ¥æœºåˆ¶ï¼ˆæ‰€æœ‰æœåŠ¡ï¼‰
- âœ… ä¾èµ–é¡ºåºç®¡ç†ï¼ˆPostgreSQL â†’ Backend â†’ Frontendï¼‰
- âœ… è‡ªåŠ¨é‡å¯ç­–ç•¥ï¼ˆ`unless-stopped`ï¼‰
- âœ… æ•°æ®æŒä¹…åŒ–ï¼ˆDocker volumeï¼‰

### å¯ç»´æŠ¤æ€§
- âœ… Bind mountæ”¯æŒä»£ç çƒ­æ›´æ–°
- âœ… Alembicè‡ªåŠ¨æ•°æ®åº“è¿ç§»
- âœ… è¯¦ç»†æ—¥å¿—è¾“å‡º
- âœ… ä¸€é”®å¯åŠ¨/åœæ­¢

### å¯ç§»æ¤æ€§
- âœ… è·¨æœºå™¨éƒ¨ç½²ï¼ˆä¿®æ”¹IPå³å¯ï¼‰
- âœ… è·¨å¹³å°å…¼å®¹ï¼ˆLinux/Mac/Windowsï¼‰
- âœ… ç¯å¢ƒå˜é‡å¤–éƒ¨åŒ–ï¼ˆ`.env.docker`ï¼‰

---

## ğŸ“ éƒ¨ç½²æ­¥éª¤

### æœ¬åœ°æµ‹è¯•
```bash
./docker-start.sh
# è®¿é—®: http://localhost:3002
```

### ç”Ÿäº§éƒ¨ç½²ï¼ˆ192.168.101.9ï¼‰
```bash
# 1. æ‰“åŒ…
tar czf qdmgt-docker.tar.gz <files>

# 2. ä¼ è¾“
scp qdmgt-docker.tar.gz user@192.168.101.9:~/

# 3. éƒ¨ç½²
ssh user@192.168.101.9
tar xzf qdmgt-docker.tar.gz
cp .env.docker.example .env.docker
vim .env.docker  # ä¿®æ”¹IPå’Œå¯†ç 
./docker-start.sh
```

---

## ğŸ” ç»éªŒæ€»ç»“

### æˆåŠŸå› ç´ 
1. **ç‰ˆæœ¬é€‰æ‹©:** Python 3.11æ¯”3.13æ›´ç¨³å®š
2. **ç¼–è¯‘å·¥å…·:** æå‰å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–
3. **ç½‘ç»œéš”ç¦»:** PostgreSQLå†…éƒ¨ç½‘ç»œæå‡å®‰å…¨æ€§
4. **è‡ªåŠ¨åŒ–:** Alembicè‡ªåŠ¨è¿ç§»å‡å°‘äººå·¥æ“ä½œ

### æŠ€æœ¯å€ºåŠ¡
1. é•œåƒå¤§å°è¾ƒå¤§ï¼ˆ~500MBï¼‰- åç»­å¯ä¼˜åŒ–
2. ç¼–è¯‘ä¾èµ–ä¿ç•™åœ¨è¿è¡Œæ—¶é•œåƒ - å¯è€ƒè™‘å¤šé˜¶æ®µæ„å»º

### æœ€ä½³å®è·µ
1. ä½¿ç”¨ç¨³å®šçš„LTSç‰ˆæœ¬ï¼ˆPython 3.11è€Œé3.13ï¼‰
2. å®Œæ•´çš„ç¼–è¯‘ä¾èµ–ï¼ˆé¿å…æ„å»ºå¤±è´¥ï¼‰
3. PostgreSQLä¸æš´éœ²ç«¯å£ï¼ˆå®‰å…¨ç¬¬ä¸€ï¼‰
4. è¯¦ç»†çš„æ–‡æ¡£å’Œè„šæœ¬ï¼ˆé™ä½éƒ¨ç½²é—¨æ§›ï¼‰

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] PostgreSQLå®¹å™¨åŒ–ä¸”ä»…å†…éƒ¨è®¿é—®
- [x] æ•°æ®Docker volumeæŒä¹…åŒ–
- [x] ä»£ç bind mountæ”¯æŒçƒ­æ›´æ–°
- [x] ä¸€é”®å¯åŠ¨/åœæ­¢è„šæœ¬
- [x] è‡ªåŠ¨æ•°æ®åº“è¿ç§»
- [x] CORSåŠ¨æ€é…ç½®
- [x] å®Œæ•´éƒ¨ç½²æ–‡æ¡£
- [x] æ•°æ®è¿ç§»å·¥å…·

---

**å®æ–½äººå‘˜:** Claude + Jian  
**å®Œæˆæ—¶é—´:** 2025-10-20 11:30  
**çŠ¶æ€:** âœ… å®Œæˆå¹¶éªŒè¯
